<script type="text/html" data-template-name="context-init">
    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> </label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="bp">COBPjs</option>
            </select>
            <button type="button" id="node-template-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
</script>

<script src="/context/editor/mode-bp.js"></script>
<script src="/context/editor/bp_highlight_rules.js"></script>
<script src="/context/editor/worker-bp.js"></script>

<script type="text/javascript">
  const defaultTemplate=`// Add entities
ctx.populateContext([
  // list of entities: ctx.Entity('unique-id', 'type', { data: 'data' }),
]);

// Register Queries
ctx.registerQuery('query-unique-name', function (entity) {
 // a function that returns true if the entity matches the query
  return false;
});

// Register Effects
ctx.registerEffect('event-name', function (data) {
  // a change to the context entities based on the event
});
`;

  RED.nodes.registerType('context-init', {
    color: '#E2D96E',
    category: 'core',
    defaults: {
      name: { value: "" },
      format: { value: "bp" },
      template: { value: defaultTemplate },
    },
    inputs: 0,
    outputs: 0,
    icon: "font-awesome/fa-database",
    label: "init context",
    paletteLabel: 'context init',
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function () {
      const that = this;
      const stateId = RED.editor.generateViewStateId("node", this, "");
      this.editor = RED.editor.createEditor({
        id: 'node-input-template-editor',
        mode: 'ace/mode/javascript',
        stateId: stateId,
        value: $("#node-input-template").val()
      });

      /*this.editor.getSession().setMode({
        path: 'ace/mode/bp',
        v: Date.now()
      });*/

      /*$("#node-input-format").on("change", function () {
        var mod = "ace/mode/" + $("#node-input-format").val();
        that.editor.getSession().setMode({
          path: mod,
          v: Date.now()
        });
      });*/
      RED.popover.tooltip($("#node-template-expand-editor"), RED._("node-red:common.label.expand"));
      $("#node-template-expand-editor").on("click", function (e) {
        e.preventDefault();
        const value = that.editor.getValue();
        that.editor.saveView();
        RED.editor.editText({
          mode: $("#node-input-format").val(),
          value: value,
          stateId: stateId,
          width: "Infinity",
          focus: true,
          complete: function (v, cursor) {
            that.editor.setValue(v, -1);
            setTimeout(function () {
              that.editor.restoreView();
              that.editor.focus();
            }, 250);
          }
        })
      })
    },
    oneditsave: function () {
      $("#node-input-template").val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },
    oneditcancel: function () {
      this.editor.destroy();
      delete this.editor;
    },
    oneditresize: function (size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i = 0; i < rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
      $("#dialog-form .node-text-editor").css("height", height + "px");
      this.editor.resize();
    }
  });
</script>